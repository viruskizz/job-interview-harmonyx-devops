name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
      branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  scan:
    uses: ./.github/workflows/tpl-scan.yml
    secrets: inherit

  unit-test:
    uses: ./.github/workflows/tpl-unit-test.yml
    secrets: inherit

  build:
    needs: [scan, unit-test]
    uses: ./.github/workflows/tpl-build.yml
    secrets: inherit

  publish:
    needs: [build]
    uses: ./.github/workflows/tpl-publish.yml
    secrets: inherit

  dev-approval-gate:
    needs: publish
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: approved
        env: 
          ENV_NAME: Development
        run: write-host "Approve for $($env.ENV_NAME)"

  deploy:
    needs: dev-approval-gate
    runs-on: ubuntu-latest
    # SECURITY ISSUE: No environment-specific deployment
    # SECURITY ISSUE: No approval gate for production deployment
    
    steps:
    - uses: actions/checkout@ee0669bd1cc54295c223e0bb666b733df41de1c5 #v2
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name my-cluster --region ${{ vars.AWS_REGION }}
    
    - name: Deploy to Kubernetes
      run: |
        # SECURITY ISSUE: No validation of Kubernetes manifests
        kubectl apply -f infra/deployment.yaml
        # SECURITY ISSUE: No rollback strategy
        # SECURITY ISSUE: No verification of deployment health
    
    # SECURITY ISSUE: No DAST scanning post-deployment
    # SECURITY ISSUE: No compliance validation
